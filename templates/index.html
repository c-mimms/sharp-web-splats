<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHARP VR - Photo to Splat</title>
    <script type="importmap">
        {
            "imports": {
                "playcanvas": "/node_modules/playcanvas/build/playcanvas.mjs"
            }
        }
    </script>
    <script type="module" src="/node_modules/@playcanvas/web-components/dist/pwc.mjs"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Inter', sans-serif;
            color: white;
        }

        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 300px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        h1 {
            font-size: 1.2rem;
            margin: 0;
            font-weight: 600;
            background: linear-gradient(90deg, #fff, #aaa);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        input[type="file"] {
            display: none;
        }

        .custom-file-upload {
            border: 1px dashed rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            color: #ccc;
            font-size: 0.9rem;
        }

        .custom-file-upload:hover {
            border-color: #fff;
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
        }

        button:hover {
            background: #0062CC;
        }

        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        #status {
            font-size: 0.8rem;
            color: #888;
            height: 1.2em;
        }

        #preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
            display: none;
            background: #333;
        }

        #sampleGallery {
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        #sampleGallery h2 {
            font-size: 0.9rem;
            margin: 10px 0 5px;
            color: #aaa;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 10px;
        }

        #samplesList {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }

        .sample-thumb {
            cursor: pointer;
            width: 100%;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .sample-thumb:hover {
            border-color: #007AFF;
        }

        .manual-links {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 10px;
        }

        .manual-links a {
            color: #007AFF;
            text-decoration: none;
            font-size: 0.75rem;
            margin-right: 10px;
        }

        .manual-links a:hover {
            text-decoration: underline;
        }

        body:fullscreen #ui {
            display: none;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(0, 122, 255, 0.9);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            transition: all 0.2s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .control-btn:hover {
            background: rgba(0, 122, 255, 1);
            transform: scale(1.1);
        }
    </style>
</head>

<body>
    <div id="ui">
        <h1>SHARP Generator</h1>

        <label class="file-upload">
            <input type="file" id="imageInput" accept="image/*" onchange="previewImage()">
            <div class="custom-file-upload" id="uploadLabel">Choose Photo</div>
        </label>

        <img id="preview" src="" alt="Preview">

        <button id="generateBtn" onclick="uploadImage()" disabled>Generate 3D Splat</button>
        <div id="status">Ready</div>

        <div id="sampleGallery">
            <h2>Or Try a Sample:</h2>
            <div id="samplesList"></div>
        </div>

        <div class="manual-links">
            Example Splats:<br>
            <a href="#" onclick="loadSample('/static/samples/apollo.sog'); return false;">Apollo.sog</a>
            <a href="#" onclick="loadSample('/static/samples/canyon.sog'); return false;">Canyon.sog</a>
        </div>

        <div style="font-size: 0.7rem; color: #555; margin-top: 10px;">
            Uses Apple SHARP & PlayCanvas. Click AR/VR buttons below to enter XR.
        </div>
    </div>

    <!-- PlayCanvas App -->
    <pc-app antialias="false" depth="false" high-resolution="false" stencil="false" xr-mode="vr">
        <!-- Script Assets -->
        <pc-asset src="/node_modules/playcanvas/scripts/esm/camera-controls.mjs"></pc-asset>
        <pc-asset src="/node_modules/playcanvas/scripts/esm/xr-controllers.mjs"></pc-asset>
        <pc-asset src="/node_modules/playcanvas/scripts/esm/xr-navigation.mjs"></pc-asset>
        <pc-asset src="/node_modules/playcanvas/scripts/esm/xr-session.mjs"></pc-asset>

        <!-- Initial Splat Asset -->
        <pc-asset id="initialSplat" type="gsplat" src="/static/samples/apollo.sog"></pc-asset>

        <pc-scene>
            <!-- Camera -->
            <pc-entity name="camera root">
                <pc-entity name="camera" position="0 2 3.5">
                    <pc-camera clear-color="0.05 0.05 0.05" far-clip="100"></pc-camera>
                    <pc-scripts>
                        <pc-script name="cameraControls" attributes='{
                            "enableFly": false,
                            "enablePan": true,
                            "focusPoint": "vec3:0,2,0",
                            "sceneSize": 10,
                        }'></pc-script>
                    </pc-scripts>
                </pc-entity>
                <pc-scripts>
                    <pc-script name="xrControllers"></pc-script>
                    <pc-script name="xrNavigation"></pc-script>
                    <pc-script name="xrSession"></pc-script>
                </pc-scripts>
            </pc-entity>

            <!-- Light -->
            <pc-entity name="light" rotation="45 45 0">
                <pc-light type="directional" intensity="1"></pc-light>
            </pc-entity>

            <!-- Splat Entity -->
            <pc-entity name="splatEntity" position="0 1 0" rotation="180 45 0">
                <pc-splat asset="initialSplat"></pc-splat>
            </pc-entity>
        </pc-scene>
    </pc-app>

    <!-- Controls -->
    <div class="controls">
        <button class="control-btn" id="arBtn" title="Enter AR" style="display: none;">ðŸ“±</button>
        <button class="control-btn" id="vrBtn" title="Enter VR" style="display: none;">ðŸ¥½</button>
        <button class="control-btn" id="fsBtn" title="Toggle Fullscreen">â›¶</button>
    </div>

    <script type="module">
        import { XRTYPE_AR, XRTYPE_VR, Asset } from '/node_modules/playcanvas/build/playcanvas.mjs';

        // Global PlayCanvas app reference
        let pcApp = null;

        // Initialize PlayCanvas and load samples
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for PlayCanvas to be ready
            const appElement = document.querySelector('pc-app');
            await appElement.ready();
            pcApp = appElement.app;
            console.log("PlayCanvas app ready");

            // Setup XR buttons
            const arBtn = document.getElementById('arBtn');
            const vrBtn = document.getElementById('vrBtn');
            const fsBtn = document.getElementById('fsBtn');

            if (pcApp.xr) {
                arBtn.onclick = () => pcApp.fire('ar:start');
                arBtn.style.display = pcApp.xr.isAvailable(XRTYPE_AR) ? 'flex' : 'none';

                vrBtn.onclick = () => pcApp.fire('vr:start');
                vrBtn.style.display = pcApp.xr.isAvailable(XRTYPE_VR) ? 'flex' : 'none';

                pcApp.xr.on('available', (type, available) => {
                    switch (type) {
                        case XRTYPE_AR:
                            arBtn.style.display = available ? 'flex' : 'none';
                            break;
                        case XRTYPE_VR:
                            vrBtn.style.display = available ? 'flex' : 'none';
                            break;
                    }
                });
            }

            fsBtn.onclick = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            };

            // Load sample gallery
            try {
                const response = await fetch('/api/samples');
                const samples = await response.json();

                if (samples.length > 0) {
                    const gallery = document.getElementById('sampleGallery');
                    const list = document.getElementById('samplesList');
                    gallery.style.display = 'block';

                    samples.forEach(s => {
                        const img = document.createElement('img');
                        img.src = s.image;
                        img.className = 'sample-thumb';
                        img.title = s.name;
                        img.onclick = () => loadSample(s.splat);
                        list.appendChild(img);
                    });
                }
            } catch (e) {
                console.error("Failed to load samples:", e);
            }
        });

        // Load splat using proper PlayCanvas Asset API
        window.loadSample = function (url) {
            if (!pcApp) {
                console.error("PlayCanvas app not ready!");
                return;
            }

            const splatEntity = pcApp.root.findByName('splatEntity');
            if (!splatEntity) {
                console.error("Splat entity not found!");
                return;
            }

            // Create new asset using imported Asset class
            const splatAsset = new Asset('dynamicSplat', 'gsplat', {
                url: url + '?t=' + Date.now()
            });

            pcApp.assets.add(splatAsset);

            splatAsset.once('load', function (asset) {
                const gsplatComponent = splatEntity.gsplat;
                if (gsplatComponent) {
                    gsplatComponent.asset = asset;
                    document.getElementById('status').innerText = "Loaded!";
                    console.log("Splat loaded:", url);
                }
            });

            pcApp.assets.load(splatAsset);
        };

        // Image preview
        window.previewImage = function () {
            const file = document.getElementById('imageInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.getElementById('preview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    document.getElementById('uploadLabel').textContent = file.name;
                    document.getElementById('generateBtn').disabled = false;
                }
                reader.readAsDataURL(file);
            }
        };

        // Upload and generate splat
        window.uploadImage = async function () {
            const file = document.getElementById('imageInput').files[0];
            if (!file) return;

            const btn = document.getElementById('generateBtn');
            const status = document.getElementById('status');

            btn.disabled = true;
            btn.innerText = "Generating...";
            status.innerText = "Processing (~1-5s)...";

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/generate', { method: 'POST', body: formData });
                if (!response.ok) throw new Error(await response.text());

                const data = await response.json();
                loadSample(data.url);

                status.innerText = "Done!";
                btn.innerText = "Generate Another";
                btn.disabled = false;
            } catch (e) {
                console.error(e);
                status.innerText = "Error: " + e.message;
                btn.disabled = false;
                btn.innerText = "Try Again";
            }
        };
    </script>
</body>

</html>